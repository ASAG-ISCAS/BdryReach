/*
 * @Author: your name
 * @Date: 2021-11-11 17:24:27
 * @LastEditTime: 2021-12-28 18:18:30
 * @LastEditors: Please set LastEditors
 * @Description: 打开koroFileHeader查看配置 进行设置:
 * https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
 * @FilePath: /Solver/test.cpp
 */

#include <plotter/matplotlibcpp.h>
#include <plotter/plotter.h>
#include <underApprox/underApprox.h>

namespace plt = matplotlibcpp;

using namespace std;
using namespace reachSolver;
using namespace capd;
using capd::autodiff::Node;

double mu = 1.;

void _f(Node/* t*/, Node in[], int /*dimIn*/, Node out[], int/* dimOut*/, Node params[], int noParams){
    out[0] = -in[1];
    out[1] = -(0.2 - 0.7*sin(in[0]) - 0.05 * in[1]);
}

void _fBack(Node/* t*/, Node in[], int /*dimIn*/, Node out[], int/* dimOut*/, Node params[], int noParams){
    out[0] = in[1];
    out[1] = (0.2 - 0.7*sin(in[0]) - 0.05 * in[1]);
}

//be care for
int dimIn = 3;

int dimOut = 2;
int noParam = 0;
int MaxDerivativeOrder = 3;

IMap f(_f, dimIn,dimOut,noParam,MaxDerivativeOrder);
IMap fBack(_fBack, dimIn,dimOut,noParam,MaxDerivativeOrder);
int main()
{
    NonlinearSys<double> mysys(f, 2, 0, 2);
	NonlinearSys<double> mysysBack(fBack, 2, 0, 2);

    ReachOptions<double> options;

    // create R0
    Vector_t<double> center(2);
    center << 0, 3;
	// center << -7.5, 2.8;
    Matrix_t<double> generators(2,2);
    generators<< 0.1,0,
                 0,0.1;

    Zonotope<double> R0_(center,generators);

    options.set_time_step(0.2);
    options.set_taylor_terms(4);
    options.set_zonotope_order(50);
    options.set_intermediate_order(50);
    options.set_error_order(20);
    options.set_alg("lin");
    options.set_tensor_order(3);

	options.set_tFinal(3);
    options.set_tStart(0);

    options.set_R0(R0_);

    options.set_usekrylovError(1);
    options.set_max_error(DBL_MAX*Eigen::MatrixXd::Ones(2,1));
	
	plt::figure_size(1200, 780);
	
	clock_t start, end;
	start = clock();

    //4s 142.5s (148.69s)
	// vector<Zonotope<double>> underR = UnderApprox::underReachClp(mysys, mysysBack, options, R0_, 0.5, 8, 0.01, 0.01, 0.01, 50, 50);
//     [-10.3342513112298 0.01289261070972439 6.057012201531131e-05 2.789144332972999e-05 5.479365505136621e-06 -0.3894432372191245 4.856410772489933e-06 5.330858596706122e-06 -2.499981911752389e-06 -2.501560533733048e-06 -2.496408013793522e-06 -2.50117461110545e-06 -2.490808034010619e-06 -2.498857164735448e-06 -2.48315948936951e-06 -2.494639901219603e-06 -2.473439668191401e-06 -2.488561723570633e-06 -2.461631037563838e-06 -2.48066177838952e-06 -2.447718939976774e-06 -2.470980781070289e-06 -2.43169242827346e-06 -1.859548703847847e-06 -2.413544434302104e-06 -1.84732406817242e-06 2.672401746157012e-06 -2.393271980023974e-06 -1.833873209696639e-06 -2.370876349265059e-06 -1.819234423626211e-06 -2.346363245478022e-06 2.718568328630837e-06 -1.803446239806648e-06 -2.319742959673567e-06 -1.786547333708566e-06 -2.291030497942801e-06 -1.768576395245189e-06 -2.260245736105506e-06 -1.749572008024371e-06 5.164935891690105e-06 -1.729572530450024e-06 -1.708615984311345e-06 -1.686739954861812e-06 -1.66398148975325e-06 5.570740491585866e-05 ;
// 2.308416863054322 -0.002943804014390811 -1.805913922780071e-05 -1.029248783466488e-05 -2.283206123741687e-06 0.2084328487875275 -2.09236705439281e-06 -2.330974774806274e-06 1.276129223840831e-06 1.276914385479295e-06 1.27405630017584e-06 1.276427524805417e-06 1.270681045043655e-06 1.274686726406737e-06 1.265994373194233e-06 1.271710548730064e-06 1.259988343839897e-06 1.267522330259738e-06 1.252658939589445e-06 1.262146603143989e-06 1.244004907706396e-06 1.255609729668661e-06 1.234028197666231e-06 9.434401951316714e-07 1.222734053959967e-06 9.355747773233779e-07 -1.211087327595903e-06 1.210131125193598e-06 9.269150077036686e-07 1.196231547535215e-06 9.174882085724728e-07 1.181051015142797e-06 -1.2388965620604e-06 9.07322404430377e-07 1.164608849434481e-06 8.964462406429802e-07 1.146928041393464e-06 8.848888813063539e-07 1.128035300611729e-06 8.726799131298468e-07 -2.377754050159123e-06 8.598492511700899e-07 8.464270493904904e-07 8.324436181280731e-07 8.179293422910883e-07 -2.654024525348344e-05 ;]

    //4s (74.42s) this good!!!
    // vector<Zonotope<double>> underR = UnderApprox::underReachClp(mysys, mysysBack, options, R0_, 0.5, 8, 0.01, 0.005, 0.01, 50, 50);
//     [-10.33407550347246 0.01289223370920165 5.256808575780461e-05 -0.3895990659897102 0.000137897417173642 ;
// 2.308323670045765 -0.002942911614022952 -1.567359609717042e-05 0.2085086109863423 -6.569599822497432e-05 ;]

    //4s 164s   (91.95s)
    // vector<Zonotope<double>> underR = UnderApprox::underReachClp(mysys, mysysBack, options, R0_, 0.4, 10, 0.01, 0.005, 0.01, 50, 50);
//     [-10.33207806240251 0.01079898871090324 4.574393500345741e-06 2.183515933503097e-05 7.258690589401262e-06 8.937146134064113e-06 1.352691159667427e-06 1.73084382848952e-06 -0.3847683495325766 8.809001238829541e-06 2.335388011588956e-05 3.162397502902889e-05 ;
// 2.307513549758368 -0.002455743516867464 -1.080157046182512e-06 -5.917110382140803e-06 -2.779419843794518e-06 -3.563346955018902e-06 -5.491487387473318e-07 -7.183091237608099e-07 0.2058339209407792 -3.85534573493815e-06 -1.045548067843015e-05 -1.482225616217431e-05 ;]





//     [-10.3324375504251 0.01078036270893248 3.709399978642386e-05 5.195329577803778e-06 2.065656727414073e-06 2.194051355344276e-06 3.363240388043787e-06 2.378640540767895e-06 2.489434557544063e-06 2.948005343830913e-06 -0.384465000607995 7.0179634332431e-06 2.160942685684695e-05 -2.071575603290404e-06 -2.071689724629977e-06 -2.069798987644218e-06 -2.070170790655013e-06 -2.066333663215073e-06 -2.067047502511806e-06 -2.061156367821894e-06 -2.062351553871487e-06 -2.054246387821069e-06 -2.056116622333741e-06 -2.045585741890398e-06 -2.048377816819397e-06 -2.035159361589807e-06 -2.039171455524903e-06 2.108650268432936e-05 -2.022955266790974e-06 -2.02853501864367e-06 -2.00896473592061e-06 -2.016506784957566e-06 -1.993182470395949e-06 -2.003125811010304e-06 -1.975606752393532e-06 -1.988431712414518e-06 -1.956239583613858e-06 -1.972464499362673e-06 -1.935087169467241e-06 -1.955264466902154e-06 -2.249935290358003e-06 -1.936871972802611e-06 -2.219346649167642e-06 -1.917327432821787e-06 -2.186753760875011e-06 -1.896671053486188e-06 -2.152186818378892e-06 -1.87494277139731e-06 3.476496735364092e-05 -1.8521821469303e-06 -2.115681021932296e-06 -1.828428280337574e-06 -1.803719627540688e-06 -1.778093990047836e-06 -1.751588406193525e-06 -1.696081233244105e-06 -1.724239068030759e-06 ;
// 2.307707238193283 -0.002452013012527397 -8.758872341970366e-06 -1.918712434247327e-06 -8.074079194979884e-07 -8.708165222301631e-07 -1.349310552991223e-06 -9.656897910804127e-07 -1.022141128515871e-06 -1.223484125288736e-06 0.2056766928023323 -3.071508712590937e-06 -9.522684679413588e-06 1.057119667587385e-06 1.057153595632078e-06 1.056013750312798e-06 1.056131002500325e-06 1.053823028400166e-06 1.054067958095153e-06 1.050537226430748e-06 1.050983007341486e-06 1.046148425967781e-06 1.046896622606873e-06 1.040651179212e-06 1.041830887296004e-06 1.034042617533171e-06 1.035809346981116e-06 -9.622921778862445e-06 1.026322553581827e-06 1.028856948421656e-06 1.017493576635515e-06 1.020999817250959e-06 1.007561140550852e-06 1.012265209372964e-06 9.965336435796626e-07 1.00268136165815e-06 9.84422493540986e-07 9.92277370347247e-07 9.712423410741995e-07 9.810830973488802e-07 1.126063223139354e-06 9.691290205262755e-07 1.107317764321538e-06 9.564461938477642e-07 1.087416958915332e-06 9.430660767441362e-07 1.066394915297937e-06 9.290204681756894e-07 -1.632073175425116e-05 9.143414188182414e-07 1.044289370620157e-06 8.990611555020554e-07 8.832119576709525e-07 8.668261212993366e-07 8.499358754949937e-07 8.147703226954309e-07 8.325733134375991e-07 ;]

//     [-10.3342513112298 0.01289261070972439 6.057012201531131e-05 2.789144332972999e-05 5.479365505136621e-06 -0.3894432372191245 4.856410772489933e-06 5.330858596706122e-06 -2.499981911752389e-06 -2.501560533733048e-06 -2.496408013793522e-06 -2.50117461110545e-06 -2.490808034010619e-06 -2.498857164735448e-06 -2.48315948936951e-06 -2.494639901219603e-06 -2.473439668191401e-06 -2.488561723570633e-06 -2.461631037563838e-06 -2.48066177838952e-06 -2.447718939976774e-06 -2.470980781070289e-06 -2.43169242827346e-06 -1.859548703847847e-06 -2.413544434302104e-06 -1.84732406817242e-06 2.672401746157012e-06 -2.393271980023974e-06 -1.833873209696639e-06 -2.370876349265059e-06 -1.819234423626211e-06 -2.346363245478022e-06 2.718568328630837e-06 -1.803446239806648e-06 -2.319742959673567e-06 -1.786547333708566e-06 -2.291030497942801e-06 -1.768576395245189e-06 -2.260245736105506e-06 -1.749572008024371e-06 5.164935891690105e-06 -1.729572530450024e-06 -1.708615984311345e-06 -1.686739954861812e-06 -1.66398148975325e-06 5.570740491585866e-05 ;
// 2.308416863054322 -0.002943804014390811 -1.805913922780071e-05 -1.029248783466488e-05 -2.283206123741687e-06 0.2084328487875275 -2.09236705439281e-06 -2.330974774806274e-06 1.276129223840831e-06 1.276914385479295e-06 1.27405630017584e-06 1.276427524805417e-06 1.270681045043655e-06 1.274686726406737e-06 1.265994373194233e-06 1.271710548730064e-06 1.259988343839897e-06 1.267522330259738e-06 1.252658939589445e-06 1.262146603143989e-06 1.244004907706396e-06 1.255609729668661e-06 1.234028197666231e-06 9.434401951316714e-07 1.222734053959967e-06 9.355747773233779e-07 -1.211087327595903e-06 1.210131125193598e-06 9.269150077036686e-07 1.196231547535215e-06 9.174882085724728e-07 1.181051015142797e-06 -1.2388965620604e-06 9.07322404430377e-07 1.164608849434481e-06 8.964462406429802e-07 1.146928041393464e-06 8.848888813063539e-07 1.128035300611729e-06 8.726799131298468e-07 -2.377754050159123e-06 8.598492511700899e-07 8.464270493904904e-07 8.324436181280731e-07 8.179293422910883e-07 -2.654024525348344e-05 ;]

    //2.5s  final_time 1
    // vector<Zonotope<double>> underR = UnderApprox::underReachClp(mysys, mysysBack, options, R0_, 0.5, 5, 0.02, 0.005, 0.01, 50, 50);

    //3s    final_time 2
        // vector<Zonotope<double>> underR = UnderApprox::underReachClp(mysys, mysysBack, options, R0_, 0.5, 6, 0.01, 0.005, 0.01, 50, 50);

        vector<Zonotope<double>> underR = UnderApprox::underReachClp(mysys, mysysBack, options, R0_, 3, 1, 0.01, 0.005, 0.005, 50,50);
	end = clock();
	cout << "time cost: " << (double) (end - start) / CLOCKS_PER_SEC << endl;
	
    cout << "R0" << endl;
    cout << R0_.interval() << endl;
	for(int i = 1; i < underR.size() ; i++){
		Plotter::plotZonotope(underR[i], 1, 2, "g");
	}
	Plotter::plotZonotope(R0_, 1, 2, "k");
	plt::show();

}
